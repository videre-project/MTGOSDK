<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
    <TargetFramework>net48</TargetFramework>
    <LangVersion>Latest</LangVersion>
    <OutputType>Library</OutputType>
    <RootNamespace>ScubaDiver</RootNamespace>
    <IsPackable>false</IsPackable>
    <EnableSourceLink>false</EnableSourceLink>
  </PropertyGroup>

  <!-- Compiler Options -->
  <PropertyGroup>
    <Deterministic>true</Deterministic>
    <FileAlignment>512</FileAlignment>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <ResolveAssemblyReferencesSilent>true</ResolveAssemblyReferencesSilent>
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
  </PropertyGroup>

  <!-- Debugging Options -->
  <PropertyGroup Condition="'$(Configuration)' == 'Debug'">
    <DefineConstants>DEBUG;TRACE</DefineConstants>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)' == 'Release'">
    <DefineConstants>TRACE</DefineConstants>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Diagnostics.Runtime"
                      Version="3.1.512801" />
    <ProjectReference Include="$(SolutionDir)\MTGOSDK\MTGOSDK.csproj"
                      SetTargetFramework="TargetFramework=$(MTGOSDKCoreTFM)" />
    <ProjectReference Include="$(SolutionDir)\MTGOSDK.Win32\MTGOSDK.Win32.csproj" />
    <!-- .NET Framework references and redirects -->
    <None Include="app.config" />
    <PackageReference Include="Microsoft.NETFramework.ReferenceAssemblies"
                      Version="1.0.3"
                      PrivateAssets="all" />
    <PackageReference Include="Microsoft.Bcl.AsyncInterfaces"
                      Version="8.0.0" />
    <PackageReference Include="System.Runtime.CompilerServices.Unsafe"
                      Version="6.0.0" />
    <!-- Build time dependencies -->
    <PackageReference Include="ilmerge"
                      Version="3.0.41" />
  </ItemGroup>

  <!-- Configures build-time project dependencies for the core SDK assembly -->
  <Target Name="ReferenceCoreSDK"
          BeforeTargets="ResolveProjectReferences"
          Condition="'$(UseFullSDKPaths)' == 'true'">
    <MSBuild Projects="$(SolutionDir)MTGOSDK\MTGOSDK.csproj"
             Targets="Build"
             Properties="TargetFramework=$(MTGOSDKCoreTFM)"
             Condition="!Exists('$(MTGOSDKCorePath)\MTGOSDK.dll')" />
  </Target>

  <Target Name="PostBuild" AfterTargets="PostBuildEvent">
    <ItemGroup>
      <ReferenceAssemblies Include="$(SolutionDir)dist\*\Reference\MTGO\*\*.dll" />
      <Assemblies Include="$(TargetDir)*.dll"
                  Exclude="@(ReferenceAssemblies-> '$(TargetDir)%(Filename)%(Extension)')" />
      <Flags Include="/ndebug" />
      <Flags Include="/allowDup" />
      <Flags Include="/lib=$(TargetDir)" />
      <Flags Include="/out=$(TargetDir)Microsoft.Diagnostics.Runtime.dll" />
    </ItemGroup>
    <PropertyGroup>
      <ILMergeAssemblies>@(Assemblies-> '%(Filename)%(Extension)', ' ')</ILMergeAssemblies>
      <ILMergeFlags>@(Flags-> '%(Identity)', ' ')</ILMergeFlags>
      <ILMergeCommand>$(ILMergeConsolePath) $(ILMergeAssemblies) $(ILMergeFlags)</ILMergeCommand>
    </PropertyGroup>

    <Exec Command="$(ILMergeConsolePath) $(ILMergeAssemblies) $(ILMergeFlags)" />
    <Copy SourceFiles="$(TargetDir)\Microsoft.Diagnostics.Runtime.dll"
          DestinationFolder="$(SolutionDir)dist\$(ConfigurationName)" />
  </Target>

</Project>